<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>SAS - نظام الاشتراكات</title>
  <!-- استدعاء خط Cairo -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    /* نفس التنسيقات السابقة تمامًا */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Cairo', sans-serif;
    }
    body {
      background: linear-gradient(120deg, #c9f8ff, #fce2ff);
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }

    /* التبويبات العلوية */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .tabs button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 25px;
      transition: background 0.3s, transform 0.2s;
    }
    .tabs button:hover {
      background: #2980b9;
      transform: scale(1.05);
    }
    .tabs button.active {
      background: #2980b9;
    }

    /* أقسام المحتوى */
    .section {
      display: none; /* مخفية افتراضيًا */
      background: #f9f9f9;
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: left;
    }
    .section.active {
      display: block; /* عرض القسم الفعال */
    }

    /* تبويب المشتركين */
    .search-box {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-box input[type="text"] {
      padding: 10px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s;
    }
    .search-box input[type="text"]:focus {
      border-color: #3498db;
    }
    .search-box button {
      background: #3498db;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
    }
    .search-box button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .subscribers-list {
      text-align: left;
    }
    .subscriber-card {
      background: #fff;
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: background 0.3s;
      position: relative;
    }
    .subscriber-card h3 {
      margin-bottom: 5px;
      font-size: 1.1rem;
      color: #333;
    }
    .subscriber-card p {
      margin: 4px 0;
      line-height: 1.5;
      color: #555;
    }
    /* أزرار تفعيل/تعديل/حذف */
    .card-buttons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .card-buttons button {
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s, transform 0.2s;
    }
    .card-buttons button:hover {
      transform: scale(1.05);
    }
    .btn-activate {
      background: #2ecc71;
      color: #fff;
    }
    .btn-edit {
      background: #f1c40f;
      color: #fff;
    }
    .btn-delete {
      background: #e74c3c;
      color: #fff;
    }

    /* لون أحمر عند الإيقاف */
    .stopped {
      background: #ffcccc !important;
    }
    /* لون أصفر عند الاقتراب (3 أيام أو أقل) */
    .warning {
      background: #fff899 !important;
    }

    /* تبويب إضافة مشترك */
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      outline: none;
      box-sizing: border-box;
    }
    .form-group input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 5px;
    }
    .form-group button {
      background: #27ae60;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
    }
    .form-group button:hover {
      background: #2ecc71;
      transform: translateY(-2px);
    }

    /* فوتر */
    .footer {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #555;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>SAS - نظام الاشتراكات</h1>

    <!-- التبويبات -->
    <div class="tabs">
      <!-- انتبه: استدعاء showSection(0) و showSection(1) -->
      <button id="tabListBtn" class="active" onclick="showSection(0)">المشتركين</button>
      <button id="tabAddBtn" onclick="showSection(1)">إضافة مشترك</button>
    </div>

    <!-- القسم الأول: عرض المشتركين مع البحث -->
    <div class="section active" id="listSection">
      <h2>المشتركين</h2>
      <!-- صندوق البحث -->
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ابحث عن اسم مشترك..." />
        <button id="searchBtn">بحث</button>
      </div>
      <!-- قائمة المشتركين -->
      <div class="subscribers-list" id="subscribersList"></div>
    </div>

    <!-- القسم الثاني: إضافة مشترك -->
    <div class="section" id="addSection">
      <h2>إضافة مشترك</h2>
      <div class="form-group">
        <label>اسم المشترك</label>
        <input type="text" id="subName" placeholder="مثال: أحمد محمد" />
      </div>
      <div class="form-group">
        <label>اسم اليوزر</label>
        <input type="text" id="subUser" placeholder="مثال: ahmed123" />
      </div>
      <div class="form-group">
        <label>كلمة السر</label>
        <input type="password" id="subPass" placeholder="******" />
      </div>
      <div class="form-group">
        <label>نوع الاشتراك</label>
        <select id="subType">
          <option value="لايت">لايت</option>
          <option value="ايكونمي">ايكونمي</option>
          <option value="بلص">بلص</option>
          <option value="ستندر">ستندر</option>
          <option value="تربو">تربو</option>
          <option value="بزنز">بزنز</option>
        </select>
      </div>
      <div class="form-group">
        <label>قيمة الاشتراك</label>
        <input type="text" id="subAmount" placeholder="مثال: 15000" />
      </div>
      <div class="form-group">
        <input type="checkbox" id="subDebt" />
        <label for="subDebt" style="display:inline;">تفعيل بالأجل</label>
      </div>
      <div class="form-group">
        <!-- لاحظ: onclick="addSubscriber()" -->
        <button onclick="addSubscriber()">إضافة المشترك</button>
      </div>
    </div>

    <!-- فوتر -->
    <div class="footer">
      <hr>
        تم تصميم هذا السكربت بواسطة طالب الطب المهندس أحمد شاكر محمود الفهداوي - كلية الطب 
        <span class="heart">❤</span> 
		</hr>
    </div>
  </div>

  <!-- سكربت من نوع module لاستدعاء فايرستور -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      addDoc, 
      updateDoc, 
      deleteDoc, 
      doc 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    /****************************************
     *       إعداد Firebase Firestore       *
     ****************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyDEWffPfy-fljp32H8AjemraCau-f9JN-M",
      authDomain: "student-notes-app-3d196.firebaseapp.com",
      projectId: "student-notes-app-3d196",
      storageBucket: "student-notes-app-3d196.appspot.com",
      messagingSenderId: "99837564904",
      appId: "1:99837564904:web:6b880e2b80e439c8fcf65d",
      measurementId: "G-N63JWQNTZF"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const subscribersCollection = collection(db, "subscribers");

    // مصفوفة في الذاكرة لتحميل/عرض المشتركين
    let subscribers = [];

    /****************************************
     *       تبويبات واجهة المستخدم         *
     ****************************************/
    function showSection(index) {
      const sections = [
        document.getElementById("listSection"),
        document.getElementById("addSection")
      ];
      const buttons = [
        document.getElementById("tabListBtn"),
        document.getElementById("tabAddBtn")
      ];
      // إخفاء الكل
      sections.forEach(sec => sec.classList.remove("active"));
      buttons.forEach(btn => btn.classList.remove("active"));

      // إظهار المطلوب
      sections[index].classList.add("active");
      buttons[index].classList.add("active");

      // إذا ذهبنا لتبويب المشتركين
      if (index === 0) renderSubscribers();
    }

    /****************************************
     *       تحميل المشتركين من فايرستور    *
     ****************************************/
    async function loadSubscribers() {
      subscribers = [];
      const snapshot = await getDocs(subscribersCollection);
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        data.id = docSnap.id; // لحفظه للعمليات اللاحقة
        subscribers.push(data);
      });
      // إذا نحن في تبويب المشتركين، نعيد العرض
      renderSubscribers();
    }

    /****************************************
     *      رسم المشتركين في الواجهة        *
     ****************************************/
    function renderSubscribers() {
      const listContainer = document.getElementById("subscribersList");
      listContainer.innerHTML = "";

      const query = document.getElementById("searchInput").value.trim();
      let filtered = subscribers.filter(sub => {
        return sub.name.includes(query);
      });

      if (filtered.length === 0) {
        listContainer.innerHTML = "<p>لا توجد نتائج مطابقة.</p>";
        return;
      }

      filtered.forEach((sub) => {
        const card = document.createElement("div");
        card.classList.add("subscriber-card");

        // لون أحمر إذا موقوف
        if (sub.status === "stopped") {
          card.classList.add("stopped");
        }
        // لون أصفر إذا تبقى 3 أيام أو أقل
        const daysLeft = calcDaysLeft(sub.endDate);
        if (sub.status !== "stopped" && daysLeft <= 3) {
          card.classList.add("warning");
        }

        card.innerHTML = `
          <h3>${sub.name} (${sub.user})</h3>
          <p><strong>نوع الاشتراك:</strong> ${sub.type}</p>
          <p><strong>قيمة الاشتراك:</strong> ${sub.amount}</p>
          <p><strong>تاريخ الانتهاء:</strong> ${sub.endDate || ""} 
             <em>(باقي ${daysLeft} يوم)</em></p>
          ${
            sub.isDebt 
            ? `<p style="color:red; font-weight:bold;">بالأجل</p>` 
            : ""
          }
        `;

        const btnContainer = document.createElement("div");
        btnContainer.classList.add("card-buttons");

        // زر التفعيل
        const activateBtn = document.createElement("button");
        activateBtn.textContent = "تفعيل";
        activateBtn.classList.add("btn-activate");
        activateBtn.onclick = () => activateSubscriber(sub.id);

        // زر التعديل
        const editBtn = document.createElement("button");
        editBtn.textContent = "تعديل";
        editBtn.classList.add("btn-edit");
        editBtn.onclick = () => editSubscriber(sub.id);

        // زر الحذف
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "حذف";
        deleteBtn.classList.add("btn-delete");
        deleteBtn.onclick = () => deleteSubscriber(sub.id);

        btnContainer.appendChild(activateBtn);
        btnContainer.appendChild(editBtn);
        btnContainer.appendChild(deleteBtn);

        card.appendChild(btnContainer);
        listContainer.appendChild(card);
      });
    }

    // حساب الأيام المتبقية
    function calcDaysLeft(endStr) {
      if (!endStr) return 0;
      const end = new Date(endStr + "T00:00:00");
      const now = new Date();
      const diffMs = end - now;
      return Math.ceil(diffMs / (1000 * 60 * 60 * 24));
    }

    /****************************************
     *   تفعيل/تعديل/حذف مشترك في فايرستور *
     ****************************************/
    // 1) تفعيل
    async function activateSubscriber(docId) {
      const sub = subscribers.find(s => s.id === docId);
      if (!sub) return;

      const now = new Date();
      now.setDate(now.getDate() + 30);
      const newEnd = formatDate(now);

      try {
        await updateDoc(doc(db, "subscribers", docId), {
          status: "active",
          reason: "",
          endDate: newEnd
        });
        alert("تم التفعيل وتم تمديد الاشتراك 30 يومًا إضافية.");
        await loadSubscribers();
      } catch (error) {
        console.error("خطأ أثناء التفعيل:", error);
        alert("حدث خطأ أثناء التفعيل.");
      }
    }

    // 2) تعديل
    async function editSubscriber(docId) {
      const sub = subscribers.find(s => s.id === docId);
      if (!sub) return;

      const newName = prompt("أدخل الاسم الجديد:", sub.name);
      if (newName === null) return;
      const newType = prompt("أدخل النوع الجديد للاشتراك:", sub.type);
      if (newType === null) return;
      const newAmount = prompt("أدخل قيمة الاشتراك الجديدة:", sub.amount);
      if (newAmount === null) return;

      try {
        await updateDoc(doc(db, "subscribers", docId), {
          name: newName,
          type: newType,
          amount: newAmount
        });
        alert("تم تعديل بيانات المشترك.");
        await loadSubscribers();
      } catch (error) {
        console.error("خطأ أثناء التعديل:", error);
        alert("حدث خطأ أثناء التعديل.");
      }
    }

    // 3) حذف
    async function deleteSubscriber(docId) {
      if (!confirm("هل أنت متأكد من حذف هذا المشترك؟")) return;
      try {
        await deleteDoc(doc(db, "subscribers", docId));
        alert("تم حذف المشترك.");
        await loadSubscribers();
      } catch (error) {
        console.error("خطأ أثناء الحذف:", error);
        alert("حدث خطأ أثناء الحذف.");
      }
    }

    /****************************************
     *      إضافة مشترك جديد في فايرستور    *
     ****************************************/
    async function addSubscriber() {
      const name = document.getElementById("subName").value.trim();
      const user = document.getElementById("subUser").value.trim();
      const pass = document.getElementById("subPass").value.trim();
      const type = document.getElementById("subType").value;
      const amount = document.getElementById("subAmount").value.trim();
      const isDebt = document.getElementById("subDebt").checked;

      if (!name || !user || !pass || !amount) {
        alert("الرجاء ملء جميع الحقول المطلوبة.");
        return;
      }

      const start = new Date();
      const end = new Date();
      end.setDate(end.getDate() + 30);

      const newSub = {
        name,
        user,
        pass,
        type,
        amount,
        isDebt,
        status: "active",
        reason: "",
        startDate: formatDate(start),
        endDate: formatDate(end)
      };

      try {
        await addDoc(subscribersCollection, newSub);
        alert("تمت إضافة المشترك بنجاح!");

        // تفريغ الحقول
        document.getElementById("subName").value = "";
        document.getElementById("subUser").value = "";
        document.getElementById("subPass").value = "";
        document.getElementById("subType").value = "لايت";
        document.getElementById("subAmount").value = "";
        document.getElementById("subDebt").checked = false;

        // انتقل لتبويب المشتركين
        showSection(0);
        // أعد تحميل البيانات
        await loadSubscribers();
      } catch (error) {
        console.error("خطأ أثناء الإضافة:", error);
        alert("حدث خطأ أثناء إضافة المشترك.");
      }
    }

    // تحويل Date إلى نص yyyy-mm-dd
    function formatDate(d) {
      let yyyy = d.getFullYear();
      let mm = (d.getMonth()+1).toString().padStart(2, "0");
      let dd = d.getDate().toString().padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    /****************************************
     *     عند تحميل الصفحة (onLoad)        *
     ****************************************/
    document.addEventListener("DOMContentLoaded", async () => {
      // تنشيط تبويب "المشتركين"
      document.getElementById("tabListBtn").classList.add("active");
      document.getElementById("listSection").classList.add("active");

      // إعداد البحث
      document.getElementById("searchBtn").addEventListener("click", () => {
        renderSubscribers();
      });
      document.getElementById("searchInput").addEventListener("input", () => {
        renderSubscribers();
      });

      // تحميل المشتركين من فايرستور
      await loadSubscribers();
    });

    /****************************************
     *    جعل الدوال مرئية لـ onclick       *
     ****************************************/
    window.showSection = showSection;
    window.addSubscriber = addSubscriber;
    window.activateSubscriber = activateSubscriber;
    window.editSubscriber = editSubscriber;
    window.deleteSubscriber = deleteSubscriber;
  </script>
</body>
</html>
